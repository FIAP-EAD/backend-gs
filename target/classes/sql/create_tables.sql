-- Script para criar as tabelas necessárias
-- Execute este script após dropar as tabelas (se necessário)

-- Adicionar coluna SESSION_ID na tabela JOB_REPORT se não existir
BEGIN
   EXECUTE IMMEDIATE 'ALTER TABLE JOB_REPORT ADD SESSION_ID VARCHAR2(100)';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -1430 THEN  -- ORA-01430: column being added already exists
         RAISE;
      END IF;
END;
/

-- Criar tabela JOB_REPORT se não existir
BEGIN
   EXECUTE IMMEDIATE '
   CREATE TABLE JOB_REPORT (
      ID_JOB_REPORT NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
      COMPANY VARCHAR2(100) NOT NULL,
      TITLE VARCHAR2(150) NOT NULL,
      DESCRIPTION CLOB NOT NULL,
      SESSION_ID VARCHAR2(100)
   )';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -955 THEN  -- ORA-00955: name is already used by an existing object
         RAISE;
      END IF;
END;
/

-- Criar tabela AUDIO_FILES
CREATE TABLE AUDIO_FILES (
   ID_AUDIO_FILE NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
   ID_JOB_REPORT NUMBER NOT NULL,
   S3_PATH VARCHAR2(500) NOT NULL,
   FILE_NAME VARCHAR2(200) NOT NULL,
   CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
   CONSTRAINT FK_AUDIO_FILES_JOB_REPORT 
      FOREIGN KEY (ID_JOB_REPORT) 
      REFERENCES JOB_REPORT(ID_JOB_REPORT) 
      ON DELETE CASCADE
);

-- Criar índice para melhorar performance nas consultas por ID_JOB_REPORT
CREATE INDEX IDX_AUDIO_FILES_JOB_REPORT ON AUDIO_FILES(ID_JOB_REPORT);

-- Criar índice para melhorar performance nas consultas por SESSION_ID
CREATE INDEX IDX_JOB_REPORT_SESSION_ID ON JOB_REPORT(SESSION_ID);

COMMIT;

